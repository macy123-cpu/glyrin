<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Glyrin AI</title>
  <style>
    /* CSS Variables */
    :root {
      --primary-bg: #000;
      --secondary-bg: #333;
      --highlight-color: orange;
      --text-color: #fff;
      --muted-text: #888;
      --border-color: rgba(255, 255, 255, 0.3);
      --shadow-color: rgba(255, 165, 0, 0.5);
      --sidebar-width: 250px;
      --spacing-sm: 10px;
      --spacing-md: 15px;
      --spacing-lg: 20px;
      --border-radius-sm: 5px;
      --border-radius-md: 10px;
      --border-radius-lg: 15px;
    }

    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    body {
      background-color: var(--primary-bg);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* Auth Container Styles */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
    .auth-box {
      background-color: var(--secondary-bg);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius-md);
      width: 400px;
      text-align: center;
    }
    .auth-box h2 {
      font-size: 32px;
      margin-bottom: var(--spacing-lg);
    }
    .auth-box input {
      width: 100%;
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-color);
      background-color: #444;
      color: var(--text-color);
      font-size: 16px;
    }
    .auth-box input::placeholder {
      color: var(--muted-text);
    }
    .auth-box button {
      width: 100%;
      padding: var(--spacing-sm);
      margin: 5px 0;
      border-radius: var(--border-radius-sm);
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    .auth-box .primary-btn {
      background-color: var(--highlight-color);
      color: var(--text-color);
    }
    .auth-box .secondary-btn {
      background-color: transparent;
      color: var(--highlight-color);
      border: 1px solid var(--highlight-color);
    }
    .auth-box .error-message {
      color: #ff5555;
      font-size: 14px;
      margin-top: var(--spacing-sm);
      display: none;
    }

    /* App Container Styles */
    .app-container {
      display: none;
      width: 100%;
      height: 100%;
    }

    /* Sidebar Styles */
    .sidebar {
      background-color: rgba(128, 128, 128, 0.2);
      width: var(--sidebar-width);
      padding: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }
    .sidebar.collapsed {
      transform: translateX(calc(-1 * var(--sidebar-width)));
    }
    .sidebar-title {
      font-size: 32px;
      margin-bottom: var(--spacing-lg);
    }
    .new-chat-btn,
    .settings-btn {
      color: var(--text-color);
      border-radius: var(--border-radius-sm);
      padding: var(--spacing-sm) var(--spacing-lg);
      cursor: pointer;
      font-size: 16px;
      border: none;
      width: 100%;
      margin-bottom: var(--spacing-lg);
    }
    .new-chat-btn {
      background-color: var(--highlight-color);
    }
    .settings-btn {
      background-color: transparent;
      border: 1px solid var(--highlight-color);
    }
    .chat-list {
      list-style: none;
      overflow-y: auto;
      flex-grow: 1;
    }
    .chat-item {
      padding: var(--spacing-sm);
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-radius: var(--border-radius-sm);
    }
    .chat-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .chat-item.selected {
      background-color: rgba(255, 255, 255, 0.2);
    }
    .chat-menu {
      position: relative;
    }
    .chat-menu-btn {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      padding: 5px;
    }
    .chat-menu-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: var(--secondary-bg);
      min-width: 120px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      z-index: 1;
      border-radius: var(--border-radius-sm);
    }
    .chat-menu-content.show {
      display: block;
    }
    .chat-menu-content button {
      color: var(--text-color);
      padding: var(--spacing-sm);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }
    .chat-menu-content button:hover {
      background-color: #555;
    }
    .sidebar-footer {
      margin-top: auto;
    }

    /* Main Content Styles */
    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: margin-left 0.3s ease;
    }
    .sidebar.collapsed + .main-content {
      margin-left: calc(-1 * var(--sidebar-width));
      width: calc(100% + var(--sidebar-width));
    }
    .header {
      padding: var(--spacing-md);
      display: flex;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      background: var(--primary-bg);
      z-index: 2;
      transition: all 0.3s ease;
    }
    .sidebar.collapsed + .main-content .header {
      left: 0;
      padding-left: 70px;
    }
    .header h2 {
      margin-right: var(--spacing-sm);
    }
    .model-selector-container,
    .mode-selector {
      position: relative;
      margin-right: var(--spacing-sm);
    }
    .model-selector-btn,
    .mode-btn {
      background-color: var(--secondary-bg);
      color: var(--text-color);
      padding: 8px 12px;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-color);
      cursor: pointer;
      font-size: 14px;
      font-family: Arial, sans-serif;
      display: flex;
      align-items: center;
    }
    .model-selector-btn::after,
    .mode-btn::after {
      content: '▾';
      margin-left: 5px;
    }
    .model-selector-menu,
    .mode-menu {
      display: none;
      position: absolute;
      background-color: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      z-index: 10;
    }
    .model-selector-menu.show,
    .mode-menu.show {
      display: block;
    }
    .model-selector-menu {
      top: 100%;
      left: 0;
      width: 250px;
    }
    .mode-menu {
      bottom: 100%;
      left: 0;
      width: 200px;
    }
    .model-option,
    .mode-option {
      padding: var(--spacing-sm);
      cursor: pointer;
    }
    .model-option:hover,
    .mode-option:hover {
      background-color: #444;
    }
    .model-option.selected,
    .mode-option.selected {
      outline: 2px solid var(--highlight-color);
    }
    .model-description,
    .description {
      font-size: 12px;
      color: #aaa;
    }
    .toggle-sidebar {
      background: var(--highlight-color);
      color: var(--text-color);
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      position: fixed;
      top: var(--spacing-lg);
      z-index: 10;
      transition: all 0.3s ease;
    }
    .toggle-sidebar.collapsed-sidebar-btn {
      left: var(--spacing-lg);
    }
    .toggle-sidebar.expanded-sidebar-btn {
      left: 200px;
    }

    /* Chat Area Styles */
    .chat-area {
      flex-grow: 1;
      padding: 80px var(--spacing-lg) 100px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .welcome-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    .welcome-title {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: var(--spacing-sm);
    }
    .ai-disclaimer {
      color: #ff9800;
      margin-top: var(--spacing-lg);
      text-align: center;
      font-size: 14px;
      padding: 5px var(--spacing-sm);
      background-color: rgba(255, 152, 0, 0.1);
      border-radius: var(--border-radius-sm);
    }
    .message-container {
      display: flex;
      flex-direction: column;
      max-width: 70%;
      margin: 5px 0;
    }
    .message-container.user {
      align-self: flex-end;
      align-items: flex-end;
    }
    .message-container.ai {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
    }
    .message {
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-md);
      display: flex;
      flex-direction: column;
    }
    .user-message {
      background-color: var(--highlight-color);
      color: var(--text-color);
    }
    .ai-message {
      color: var(--text-color);
    }
    .ai-icon {
      width: 24px;
      height: 24px;
      margin-right: var(--spacing-sm);
      flex-shrink: 0;
      margin-top: 2px;
    }
    .typing-cursor {
      display: inline;
      color: var(--text-color);
      animation: blink 0.7s infinite;
    }
    @keyframes blink {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .user-name {
      font-size: 12px;
      color: #ccc;
      margin-bottom: 5px;
    }

    /* Suggestions Styles */
    .suggestions-container {
      display: flex;
      justify-content: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }
    .suggestion {
      background-color: var(--secondary-bg);
      color: var(--text-color);
      padding: 8px var(--spacing-md);
      border-radius: var(--border-radius-lg);
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .suggestion:hover {
      background-color: #444;
    }

    /* Input Area Styles */
    .input-area {
      position: fixed;
      bottom: 0;
      left: var(--sidebar-width);
      right: 0;
      padding: var(--spacing-lg);
      background-color: var(--primary-bg);
      transition: all 0.3s ease;
    }
    .sidebar.collapsed + .main-content .input-area {
      left: 0;
    }
    .typing-indicator {
      display: none;
      justify-content: center;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }
    .typing-indicator.active {
      display: flex;
    }
    .typing-indicator-box {
      background-color: var(--secondary-bg);
      border-radius: var(--border-radius-lg);
      padding: 8px var(--spacing-md);
      display: flex;
      align-items: center;
      font-style: italic;
      color: var(--muted-text);
      font-size: 14px;
    }
    .stop-btn,
    .scroll-down-btn {
      background-color: #555;
      border: none;
      width: 20px;
      height: 20px;
      margin-left: var(--spacing-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-color);
      font-size: 12px;
    }
    .stop-btn:hover,
    .scroll-down-btn:hover {
      background-color: #777;
    }
    .input-container {
      display: flex;
      align-items: center;
      background-color: var(--secondary-bg);
      border-radius: 25px;
      padding: 8px var(--spacing-md);
      transition: box-shadow 0.3s ease;
    }
    .input-container:focus-within {
      box-shadow: 0 0 var(--spacing-sm) 2px var(--shadow-color);
    }
    .message-input {
      flex-grow: 1;
      background: none;
      border: none;
      color: var(--text-color);
      padding: var(--spacing-sm);
      font-size: 16px;
      outline: none;
    }
    .message-input::placeholder {
      color: var(--muted-text);
    }
    .attach-btn {
      background: none;
      border: none;
      color: var(--muted-text);
      cursor: pointer;
      padding: 0 var(--spacing-sm);
      font-size: 24px;
      transition: color 0.2s;
    }
    .attach-btn:hover {
      color: var(--highlight-color);
    }
    .send-btn {
      background-color: var(--highlight-color);
      color: var(--text-color);
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 20px;
      cursor: pointer;
      margin-left: var(--spacing-sm);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .send-btn.inactive {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .send-btn.blinking {
      animation: blink 1s infinite alternate;
    }

    /* Popup Styles */
    .settings-popup,
    .rename-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .settings-content,
    .rename-content {
      background-color: var(--secondary-bg);
      padding: 40px var(--spacing-lg) var(--spacing-lg);
      border-radius: var(--border-radius-md);
      width: 400px;
      position: relative;
    }
    .close-btn {
      position: absolute;
      top: var(--spacing-sm);
      right: var(--spacing-sm);
      color: var(--text-color);
      cursor: pointer;
      font-size: 24px;
      line-height: 1;
      padding: 5px;
    }
    .settings-tabs {
      display: flex;
      flex-direction: column;
      margin-bottom: var(--spacing-lg);
    }
    .tab-btn {
      background: none;
      border: none;
      color: var(--text-color);
      padding: var(--spacing-sm);
      text-align: left;
      cursor: pointer;
    }
    .tab-btn.active {
      background-color: var(--highlight-color);
    }
    .settings-tab-content {
      display: none;
    }
    .settings-tab-content.active {
      display: block;
    }
    .rename-content input,
    .settings-content input {
      width: 100%;
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      border: 1px solid #ccc;
    }
    .settings-content button,
    .rename-content button {
      margin: 5px 0;
      padding: var(--spacing-sm);
      width: 100%;
      border-radius: var(--border-radius-sm);
      background-color: var(--highlight-color);
      color: var(--text-color);
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Auth Container -->
  <div id="authContainer" class="auth-container">
    <div id="signupBox" class="auth-box">
      <h2>Sign Up</h2>
      <input type="text" id="signupUsername" placeholder="Username" />
      <input type="password" id="signupPassword" placeholder="Password" />
      <input type="text" id="signupFirstName" placeholder="First Name" />
      <input type="text" id="signupLastName" placeholder="Last Name" />
      <button id="signupButton" class="primary-btn">Sign Up</button>
      <button id="switchToLogin" class="secondary-btn">Log In</button>
      <div id="signupError" class="error-message"></div>
    </div>
    <div id="loginBox" class="auth-box" style="display: none;">
      <h2>Log In</h2>
      <input type="text" id="loginUsername" placeholder="Username" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button id="loginButton" class="primary-btn">Log In</button>
      <button id="switchToSignup" class="secondary-btn">Sign Up</button>
      <div id="loginError" class="error-message"></div>
    </div>
  </div>

  <!-- App Container -->
  <div id="appContainer" class="app-container">
    <button id="toggleSidebar" class="toggle-sidebar expanded-sidebar-btn" aria-label="Toggle Sidebar">‹</button>
    <div id="sidebar" class="sidebar" role="navigation">
      <h1 class="sidebar-title">Glyrin AI</h1>
      <button id="newChat" class="new-chat-btn" aria-label="New Chat">New Chat</button>
      <ul id="chatList" class="chat-list" role="list"></ul>
      <div class="sidebar-footer">
        <button id="settingsBtn" class="settings-btn" aria-label="Settings">Settings</button>
      </div>
    </div>
    <div class="main-content">
      <div class="header">
        <h2>Glyrin</h2>
        <div class="model-selector-container">
          <button id="modelSelectorBtn" class="model-selector-btn" aria-label="Select Model">Spark BETA</button>
          <div id="modelSelectorMenu" class="model-selector-menu">
            <div class="model-option" data-value="spark">
              <div>Spark BETA</div>
              <div class="model-description">Our quickest model, great for general tasks.</div>
            </div>
            <div class="model-option" data-value="pulse">
              <div>Pulse BETA</div>
              <div class="model-description">Our best model for all tasks.</div>
            </div>
            <div class="model-option" data-value="shade">
              <div>Shade BETA</div>
              <div class="model-description">Our most powerful model, for large tasks.</div>
            </div>
          </div>
        </div>
      </div>
      <div id="chatArea" class="chat-area" role="region">
        <div id="welcomeMessage" class="welcome-message">
          <div class="welcome-title" id="welcomeTitle">Hi, I'm Glyrin AI</div>
          <div>How can I assist you today?</div>
          <div class="ai-disclaimer">Glyrin uses AI, so be careful with responses.</div>
        </div>
      </div>
      <div class="input-area">
        <div id="typingIndicator" class="typing-indicator">
          <div class="typing-indicator-box">
            <span id="typingText">Glyrin is typing...</span>
            <button id="stopButton" class="stop-btn" aria-label="Stop Response">■</button>
          </div>
        </div>
        <div id="suggestionsContainer" class="suggestions-container">
          <div class="suggestion" data-prompt="What can you do?">What can you do?</div>
          <div class="suggestion" data-prompt="Invent a superhero that">Invent a superhero.</div>
          <div class="suggestion" data-prompt="Break down quantum physics">Break down quantum physics.</div>
        </div>
        <div class="input-container">
          <button id="attachButton" class="attach-btn" aria-label="Attach File">+</button>
          <input type="text" id="messageInput" class="message-input" placeholder="Message Glyrin" aria-label="Message Input" />
          <div class="mode-selector">
            <button class="mode-btn" aria-label="Select Mode">Normal</button>
            <div class="mode-menu">
              <div class="mode-option" data-mode="normal">
                <div>Normal</div>
                <div class="description">Best for normal tasks</div>
              </div>
              <div class="mode-option" data-mode="think">
                <div>Think</div>
                <div class="description">Best for harder tasks</div>
              </div>
            </div>
          </div>
          <button id="sendButton" class="send-btn inactive" aria-label="Send Message">⇑</button>
        </div>
        <input type="file" id="fileInput" style="display: none;" />
      </div>
    </div>
  </div>

  <!-- Popups -->
  <div id="settingsPopup" class="settings-popup">
    <div class="settings-content">
      <div class="close-btn" data-close="settingsPopup">×</div>
      <div class="settings-tabs">
        <button class="tab-btn active" data-tab="account">Account</button>
      </div>
      <div class="settings-tab-content active" id="accountTab">
        <h3>Account Settings</h3>
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName" value="">
        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName" value="">
        <button id="saveSettings">Save</button>
        <button id="logoutButton" class="primary-btn">Log Out</button>
      </div>
    </div>
  </div>

  <div id="renamePopup" class="rename-popup">
    <div class="rename-content">
      <div class="close-btn" data-close="renamePopup">×</div>
      <h3>Rename Chat</h3>
      <input type="text" id="renameInput" placeholder="Enter new name">
      <button id="saveRename">Save</button>
    </div>
  </div>

  <script>
    // Disable right-click context menu
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // State Management
    const state = {
      isSidebarExpanded: true,
      selectedModel: 'spark',
      selectedMode: 'normal',
      chats: [],
      selectedChat: null,
      isTyping: false,
      isThinking: false,
      settings: { firstName: '', lastName: '' },
      typingInterval: null,
      userHasScrolled: false,
      currentUser: null
    };

    // Data Structures
    class Message {
      id = Date.now().toString();
      constructor(content, isUser) {
        this.content = content;
        this.isUser = isUser;
      }
    }

    class Chat {
      id = Date.now().toString();
      messages = [];
      modelLocked = false;
      selectedModel = null;
      constructor(name) {
        this.name = name;
      }
    }

    // DOM Utilities
    const $ = (id) => document.getElementById(id);
    const elements = {
      authContainer: $('authContainer'),
      appContainer: $('appContainer'),
      signupBox: $('signupBox'),
      loginBox: $('loginBox'),
      signupUsername: $('signupUsername'),
      signupPassword: $('signupPassword'),
      signupFirstName: $('signupFirstName'),
      signupLastName: $('signupLastName'),
      signupButton: $('signupButton'),
      switchToLogin: $('switchToLogin'),
      signupError: $('signupError'),
      loginUsername: $('loginUsername'),
      loginPassword: $('loginPassword'),
      loginButton: $('loginButton'),
      switchToSignup: $('switchToSignup'),
      loginError: $('loginError'),
      sidebar: $('sidebar'),
      toggleSidebarBtn: $('toggleSidebar'),
      newChatBtn: $('newChat'),
      chatList: $('chatList'),
      modelSelectorBtn: $('modelSelectorBtn'),
      modelSelectorMenu: $('modelSelectorMenu'),
      chatArea: $('chatArea'),
      welcomeMessage: $('welcomeMessage'),
      welcomeTitle: $('welcomeTitle'),
      messageInput: $('messageInput'),
      attachButton: $('attachButton'),
      fileInput: $('fileInput'),
      sendButton: $('sendButton'),
      typingIndicator: $('typingIndicator'),
      typingText: $('typingText'),
      stopButton: $('stopButton'),
      settingsBtn: $('settingsBtn'),
      settingsPopup: $('settingsPopup'),
      logoutButton: $('logoutButton'),
      renamePopup: $('renamePopup'),
      suggestionsContainer: $('suggestionsContainer'),
      firstNameInput: $('firstName'),
      lastNameInput: $('lastName'),
      saveSettingsBtn: $('saveSettings'),
      renameInput: $('renameInput'),
      saveRenameBtn: $('saveRename')
    };

    // Utility Functions
    const debounce = (func, delay) => {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func(...args), delay);
      };
    };

    // Local Storage Utilities
    const loadFromLocalStorage = (key, defaultValue) => {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch (error) {
        console.error(`Error loading from localStorage: ${error}`);
        return defaultValue;
      }
    };

    const saveToLocalStorage = (key, value) => {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (error) {
        console.error(`Error saving to localStorage: ${error}`);
      }
    };

    // Auth Functions
    const showSignup = () => {
      elements.signupBox.style.display = 'block';
      elements.loginBox.style.display = 'none';
      elements.signupError.style.display = 'none';
    };

    const showLogin = () => {
      elements.signupBox.style.display = 'none';
      elements.loginBox.style.display = 'block';
      elements.loginError.style.display = 'none';
    };

    const signup = () => {
      const username = elements.signupUsername.value.trim();
      const password = elements.signupPassword.value.trim();
      const firstName = elements.signupFirstName.value.trim();
      const lastName = elements.signupLastName.value.trim();

      if (!username || !password || !firstName || !lastName) {
        elements.signupError.textContent = 'Please fill in all fields.';
        elements.signupError.style.display = 'block';
        return;
      }

      let users = loadFromLocalStorage('users', {});
      if (users[username]) {
        elements.signupError.textContent = 'Username already exists.';
        elements.signupError.style.display = 'block';
        return;
      }

      users[username] = {
        password,
        firstName,
        lastName,
        chats: [],
        settings: { firstName, lastName }
      };
      saveToLocalStorage('users', users);
      saveToLocalStorage('currentUser', { username, lastLoggedIn: Date.now() });

      state.currentUser = username;
      state.settings = { firstName, lastName };
      state.chats = [];
      loadChatInterface();
    };

    const login = () => {
      const username = elements.loginUsername.value.trim();
      const password = elements.loginPassword.value.trim();

      if (!username || !password) {
        elements.loginError.textContent = 'Please fill in all fields.';
        elements.loginError.style.display = 'block';
        return;
      }

      const users = loadFromLocalStorage('users', {});
      if (!users[username] || users[username].password !== password) {
        elements.loginError.textContent = 'Invalid username or password.';
        elements.loginError.style.display = 'block';
        return;
      }

      saveToLocalStorage('currentUser', { username, lastLoggedIn: Date.now() });

      state.currentUser = username;
      state.settings = users[username].settings;
      state.chats = users[username].chats;
      loadChatInterface();
    };

    const logout = () => {
      const users = loadFromLocalStorage('users', {});
      if (state.currentUser && users[state.currentUser]) {
        users[state.currentUser].chats = state.chats;
        users[state.currentUser].settings = state.settings;
        saveToLocalStorage('users', users);
      }

      saveToLocalStorage('currentUser', null);
      state.currentUser = null;
      state.chats = [];
      state.settings = { firstName: '', lastName: '' };
      elements.appContainer.style.display = 'none';
      elements.authContainer.style.display = 'flex';
      showLogin();
    };

    const loadChatInterface = () => {
      elements.authContainer.style.display = 'none';
      elements.appContainer.style.display = 'flex';
      updateUI();
    };

    const checkRecentLogin = () => {
      const currentUser = loadFromLocalStorage('currentUser', null);
      if (currentUser && currentUser.lastLoggedIn) {
        const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;
        if (Date.now() - currentUser.lastLoggedIn < sevenDaysInMs) {
          const users = loadFromLocalStorage('users', {});
          if (users[currentUser.username]) {
            state.currentUser = currentUser.username;
            state.settings = users[currentUser.username].settings;
            state.chats = users[currentUser.username].chats;
            loadChatInterface();
            return true;
          }
        }
      }
      return false;
    };

    // API Configuration
    const API_KEY = 'AIzaSyD7craLAIg_wRC5Jt49ySRhD3iGhJqnNMM';
    const getModelConfig = () => ({
      spark: { endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent', name: 'Spark BETA' },
      pulse: { endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', name: 'Pulse BETA' },
      shade: { endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-pro-exp-02-05:generateContent', name: 'Shade BETA' }
    });

    const getCurrentModelConfig = () => {
      if (state.selectedMode === 'think') {
        return {
          endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-thinking-exp-01-21:generateContent',
          name: 'Gemini 2.0 Flash Thinking Experimental'
        };
      }
      return getModelConfig()[state.selectedModel];
    };

    const fetchAIResponse = async (query, endpoint) => {
      try {
        const response = await fetch(`${endpoint}?key=${API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: query }] }] })
        });
        if (!response.ok) throw new Error(`API failed: ${response.status}`);
        const data = await response.json();
        return data.candidates[0].content.parts[0].text.trim();
      } catch (error) {
        console.error('API Error:', error);
        return `Sorry, ${getCurrentModelConfig().name} encountered an issue. Please try again.`;
      }
    };

    // New Function to Format AI Response
    const formatAIResponse = (text) => {
      let formatted = '';
      let indentLevel = 0;
      const lines = text.split('\n');

      lines.forEach((line, index) => {
        line = line.trim();
        if (!line) {
          formatted += '\n';
          return;
        }

        // Handle headings
        if (line.startsWith('#')) {
          const hashCount = line.match(/^#+/)[0].length;
          line = line.replace(/^#+/, '').trim();
          formatted += `${'  '.repeat(indentLevel)}<strong>${line}</strong>\n`;
        }
        // Handle bullet points
        else if (line.startsWith('*') || line.startsWith('-')) {
          line = line.replace(/^[*|-]\s*/, '').trim();
          formatted += `${'  '.repeat(indentLevel)}• ${line}\n`;
          indentLevel++;
        }
        // Handle numbered lists
        else if (line.match(/^\d+\.\s/)) {
          line = line.replace(/^\d+\.\s*/, '').trim();
          formatted += `${'  '.repeat(indentLevel)}${index + 1}. ${line}\n`;
          indentLevel++;
        }
        // Regular text
        else {
          formatted += `${'  '.repeat(indentLevel)}${line}\n`;
          indentLevel = Math.max(0, indentLevel - 1); // Decrease indent after list items
        }
      });

      return formatted.trim();
    };

    // Chat Management Functions
    const addNewChat = () => {
      const chat = new Chat('New Chat');
      state.chats.push(chat);
      state.selectedChat = chat;
      syncModelSelector();
      syncModeSelector();
      updateUI();
    };

    const deleteChat = (chatId) => {
      state.chats = state.chats.filter(chat => chat.id !== chatId);
      if (state.selectedChat?.id === chatId) {
        state.selectedChat = state.chats[0] || null;
        syncModelSelector();
      }
      saveUserData();
      updateUI();
    };

    const renameChat = (chatId) => {
      const chat = state.chats.find(c => c.id === chatId);
      if (!chat) return;
      elements.renamePopup.style.display = 'flex';
      elements.renameInput.value = chat.name;
    };

    const selectChat = (chatId) => {
      state.selectedChat = state.chats.find(c => c.id === chatId) || null;
      syncModelSelector();
      syncModeSelector();
      updateUI();
    };

    // UI Management Functions
    const toggleSidebar = () => {
      state.isSidebarExpanded = !state.isSidebarExpanded;
      elements.sidebar.classList.toggle('collapsed', !state.isSidebarExpanded);
      elements.toggleSidebarBtn.textContent = state.isSidebarExpanded ? '‹' : '›';
      elements.toggleSidebarBtn.classList.toggle('collapsed-sidebar-btn', !state.isSidebarExpanded);
      elements.toggleSidebarBtn.classList.toggle('expanded-sidebar-btn', state.isSidebarExpanded);
    };

    const updateSendButton = () => {
      const isDisabled = !elements.messageInput.value.trim() || state.isTyping;
      elements.sendButton.classList.toggle('inactive', isDisabled);
      elements.sendButton.disabled = isDisabled;
      elements.sendButton.classList.toggle('blinking', state.isTyping);
    };

    const lockModelSelector = () => {
      elements.modelSelectorBtn.disabled = true;
      elements.modelSelectorBtn.style.opacity = '0.6';
      elements.modelSelectorBtn.style.cursor = 'not-allowed';
    };

    const unlockModelSelector = () => {
      elements.modelSelectorBtn.disabled = false;
      elements.modelSelectorBtn.style.opacity = '1';
      elements.modelSelectorBtn.style.cursor = 'pointer';
    };

    const syncModelSelector = () => {
      if (state.selectedChat?.modelLocked && state.selectedChat.selectedModel) {
        state.selectedModel = state.selectedChat.selectedModel;
        elements.modelSelectorBtn.textContent = getModelConfig()[state.selectedModel].name;
        lockModelSelector();
      } else {
        elements.modelSelectorBtn.textContent = getModelConfig()[state.selectedModel].name;
        unlockModelSelector();
      }
      document.querySelectorAll('.model-option').forEach(option => {
        option.classList.toggle('selected', option.dataset.value === state.selectedModel);
      });
    };

    const syncModeSelector = () => {
      const modeBtn = document.querySelector('.mode-btn');
      modeBtn.textContent = state.selectedMode.charAt(0).toUpperCase() + state.selectedMode.slice(1);
      document.querySelectorAll('.mode-option').forEach(option => {
        option.classList.toggle('selected', option.dataset.mode === state.selectedMode);
      });
    };

    const toggleChatMenu = (event, chatId) => {
      event.stopPropagation();
      document.querySelectorAll('.chat-menu-content').forEach(menu => {
        if (menu.dataset.chatId !== chatId) menu.classList.remove('show');
      });
      const menu = document.querySelector(`.chat-menu-content[data-chatId="${chatId}"]`);
      if (menu) menu.classList.toggle('show');
    };

    const renderChatList = () => {
      elements.chatList.innerHTML = state.chats.map(chat => `
        <li class="chat-item ${state.selectedChat?.id === chat.id ? 'selected' : ''}" data-chat-id="${chat.id}">
          <span>${chat.name}</span>
          <div class="chat-menu">
            <button class="chat-menu-btn" data-chat-id="${chat.id}">⋯</button>
            <div class="chat-menu-content" data-chatId="${chat.id}">
              <button data-action="rename" data-chat-id="${chat.id}">Rename</button>
              <button data-action="delete" data-chat-id="${chat.id}">Delete</button>
            </div>
          </div>
        </li>
      `).join('');
    };

    const updateWelcomeMessage = () => {
      if (state.settings.firstName) {
        elements.welcomeTitle.textContent = `What's up, ${state.settings.firstName}?`;
      } else {
        elements.welcomeTitle.textContent = "Hi, I'm Glyrin AI";
      }
    };

    const renderChatArea = () => {
      if (!state.selectedChat?.messages.length) {
        elements.chatArea.innerHTML = '';
        elements.chatArea.appendChild(elements.welcomeMessage);
        elements.welcomeMessage.style.display = 'flex';
        elements.suggestionsContainer.style.display = 'flex';
        updateWelcomeMessage();
        return;
      }

      elements.welcomeMessage.style.display = 'none';
      elements.suggestionsContainer.style.display = 'none';
      elements.chatArea.innerHTML = state.selectedChat.messages.map((msg, idx) => `
        <div class="message-container ${msg.isUser ? 'user' : 'ai'} ${!msg.isUser && state.isTyping && idx === state.selectedChat.messages.length - 1 ? 'typing' : ''}">
          ${msg.isUser && state.settings.firstName ? `<div class="user-name">${state.settings.firstName}</div>` : ''}
          <div class="message ${msg.isUser ? 'user-message' : 'ai-message'}">
            ${!msg.isUser ? `
              <svg class="ai-icon" viewBox="0 0 24 24" fill="orange">
                <path d="M4 4h16v2H4V4zm0 4h16v12H4V8zm2 2v8h12v-8H6zm2 2h8v4H8v-4zm0 0h8v2H8v-2z"/>
              </svg>
            ` : ''}
            <div>${msg.isUser ? msg.content : msg.content.split('\n').join('<br>')}${!msg.isUser && state.isTyping && idx === state.selectedChat.messages.length - 1 ? '<span class="typing-cursor">|</span>' : ''}</div>
          </div>
        </div>
      `).join('');

      const isNearBottom = elements.chatArea.scrollHeight - elements.chatArea.scrollTop - elements.chatArea.clientHeight < 100;
      if (!state.userHasScrolled || isNearBottom) {
        elements.chatArea.scrollTop = elements.chatArea.scrollHeight;
      }
    };

    const scrollToBottom = () => {
      state.userHasScrolled = false;
      elements.chatArea.scrollTop = elements.chatArea.scrollHeight;
    };

    const updateTypingIndicator = () => {
      if (state.isThinking || state.isTyping) {
        elements.typingIndicator.classList.add('active');
        elements.typingText.textContent = state.isThinking ? 'Glyrin is thinking...' : 'Glyrin is typing...';
      } else {
        elements.typingIndicator.classList.remove('active');
      }
    };

    const saveUserData = () => {
      if (state.currentUser) {
        const users = loadFromLocalStorage('users', {});
        users[state.currentUser].chats = state.chats;
        users[state.currentUser].settings = state.settings;
        saveToLocalStorage('users', users);
      }
    };

    const updateUI = () => {
      renderChatList();
      renderChatArea();
      updateTypingIndicator();
      updateSendButton();
      syncModelSelector();
      syncModeSelector();
    };

    // Message Handling Functions
    const stopTyping = () => {
      if (state.typingInterval) {
        clearInterval(state.typingInterval);
        state.typingInterval = null;
      }
      state.isTyping = false;
      state.isThinking = false;
      if (state.selectedChat?.messages.length) {
        const lastMessage = state.selectedChat.messages[state.selectedChat.messages.length - 1];
        if (!lastMessage.isUser && lastMessage.content === '') {
          state.selectedChat.messages.pop();
        }
      }
      saveUserData();
      updateUI();
    };

    const processUserQuery = async (query) => {
      if (!state.selectedChat) addNewChat();
      const userMessage = new Message(query, true);
      state.selectedChat.messages.push(userMessage);

      if (state.selectedChat.messages.length === 1) {
        const words = query.split(' ');
        state.selectedChat.name = words.slice(0, 5).join(' ') + (words.length > 5 ? '...' : '');
        saveUserData();
      }

      if (!state.selectedChat.modelLocked) {
        state.selectedChat.modelLocked = true;
        state.selectedChat.selectedModel = state.selectedModel;
        lockModelSelector();
      }

      elements.messageInput.value = '';
      state.isTyping = true;
      if (state.selectedMode === 'think') {
        state.isThinking = true;
        updateUI();
        await new Promise(resolve => setTimeout(resolve, 4000)); // Increased from 2000ms to 4000ms
        state.isThinking = false;
      }
      updateUI();

      const config = getCurrentModelConfig();
      const systemInstruction = `Only mention if asked: You are Glyrin AI (Glyrin), powered by ${config.name}, created by Reedmac Industries, trained with Google DeepMind. You assist globally, aiming to enhance productivity with friendly, detailed responses. ${state.settings.firstName ? `The user's name is ${state.settings.firstName}.` : ''}`;
      const history = state.selectedChat.messages.map(m => 
        m.isUser ? `User: ${m.content}` : m.content
      ).join('\n');
      const fullQuery = `${systemInstruction}\n\n${history}\nUser query: ${query}`;

      const response = await fetchAIResponse(fullQuery, config.endpoint);
      const formattedResponse = formatAIResponse(response);
      const aiMessage = new Message('', false);
      state.selectedChat.messages.push(aiMessage);

      let charIndex = 0;
      const typeResponse = () => {
        if (charIndex < formattedResponse.length) {
          aiMessage.content += formattedResponse[charIndex++];
          updateUI();
          state.typingInterval = setTimeout(typeResponse, 30);
        } else {
          state.isTyping = false;
          state.typingInterval = null;
          saveUserData();
          updateUI();
        }
      };
      typeResponse();
    };

    const handleFileUpload = (event) => {
      const file = event.target.files[0];
      if (!file || state.isTyping) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        state.selectedChat.messages.push(new Message(`File uploaded: ${file.name}`, true));
        updateUI();
        processUserQuery(`File content: ${content}`);
      };
      reader.readAsText(file);
    };

    // Popup Management
    const closePopup = (popupId) => {
      $(popupId).style.display = 'none';
    };

    // Event Listeners
    const addEventListeners = () => {
      // Auth Event Listeners
      elements.signupButton.addEventListener('click', signup);
      elements.switchToLogin.addEventListener('click', showLogin);
      elements.loginButton.addEventListener('click', login);
      elements.switchToSignup.addEventListener('click', showSignup);

      // Sidebar and Chat Management
      elements.toggleSidebarBtn.addEventListener('click', toggleSidebar);
      elements.newChatBtn.addEventListener('click', addNewChat);

      // Chat List Event Delegation
      elements.chatList.addEventListener('click', (e) => {
        const chatItem = e.target.closest('.chat-item');
        if (chatItem) {
          const chatId = chatItem.dataset.chatId;
          if (e.target.classList.contains('chat-menu-btn')) {
            toggleChatMenu(e, chatId);
          } else if (e.target.dataset.action === 'rename') {
            renameChat(chatId);
          } else if (e.target.dataset.action === 'delete') {
            deleteChat(chatId);
          } else {
            selectChat(chatId);
          }
        }
      });

      // Model Selector
      elements.modelSelectorBtn.addEventListener('click', (e) => {
        if (elements.modelSelectorBtn.disabled) return;
        e.stopPropagation();
        elements.modelSelectorMenu.classList.toggle('show');
      });

      elements.modelSelectorMenu.addEventListener('click', (e) => {
        const option = e.target.closest('.model-option');
        if (option) {
          state.selectedModel = option.dataset.value;
          elements.modelSelectorBtn.textContent = getModelConfig()[state.selectedModel].name;
          elements.modelSelectorMenu.classList.remove('show');
          updateUI();
        }
      });

      // Message Input and Sending
      elements.messageInput.addEventListener('input', debounce(updateSendButton, 100));
      elements.messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && elements.messageInput.value.trim() && !state.isTyping) {
          processUserQuery(elements.messageInput.value.trim());
        }
      });
      elements.sendButton.addEventListener('click', () => {
        const query = elements.messageInput.value.trim();
        if (query && !state.isTyping) {
          processUserQuery(query);
        }
      });

      // Detect User Scrolling
      elements.chatArea.addEventListener('scroll', () => {
        const isNearBottom = elements.chatArea.scrollHeight - elements.chatArea.scrollTop - elements.chatArea.clientHeight < 100;
        state.userHasScrolled = !isNearBottom;
      });

      // File Upload
      elements.attachButton.addEventListener('click', () => !state.isTyping && elements.fileInput.click());
      elements.fileInput.addEventListener('change', handleFileUpload);

      // Settings Popup
      elements.settingsBtn.addEventListener('click', () => {
        elements.settingsPopup.style.display = 'flex';
        elements.firstNameInput.value = state.settings.firstName;
        elements.lastNameInput.value = state.settings.lastName;
      });
      elements.saveSettingsBtn.addEventListener('click', () => {
        state.settings.firstName = elements.firstNameInput.value.trim();
        state.settings.lastName = elements.lastNameInput.value.trim();
        saveUserData();
        closePopup('settingsPopup');
        updateUI();
      });
      elements.logoutButton.addEventListener('click', () => {
        closePopup('settingsPopup');
        logout();
      });

      // Rename Popup
      elements.saveRenameBtn.addEventListener('click', () => {
        const newName = elements.renameInput.value.trim();
        if (newName && state.selectedChat) {
          state.selectedChat.name = newName;
          saveUserData();
          updateUI();
          closePopup('renamePopup');
        }
      });

      // Popup Close on Overlay Click and Close Button
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('settings-popup')) closePopup('settingsPopup');
        if (e.target.classList.contains('rename-popup')) closePopup('renamePopup');
        if (e.target.dataset.close) closePopup(e.target.dataset.close);
        if (!e.target.closest('.model-selector-container')) {
          elements.modelSelectorMenu.classList.remove('show');
        }
        if (!e.target.closest('.mode-selector')) {
          document.querySelector('.mode-menu').classList.remove('show');
        }
      });

      // Mode Selector
      const modeSelector = document.querySelector('.mode-selector');
      const modeBtn = modeSelector.querySelector('.mode-btn');
      const modeMenu = modeSelector.querySelector('.mode-menu');

      modeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        modeMenu.classList.toggle('show');
      });

      modeMenu.addEventListener('click', (e) => {
        const option = e.target.closest('.mode-option');
        if (option) {
          state.selectedMode = option.dataset.mode;
          modeBtn.textContent = state.selectedMode.charAt(0).toUpperCase() + state.selectedMode.slice(1);
          modeMenu.classList.remove('show');
          updateUI();
        }
      });

      // Suggestions
      elements.suggestionsContainer.addEventListener('click', (e) => {
        const suggestion = e.target.closest('.suggestion');
        if (suggestion) {
          elements.messageInput.value = suggestion.dataset.prompt;
          updateSendButton();
        }
      });

      // Stop Button
      elements.stopButton.addEventListener('click', stopTyping);
    };

    // Initialization
    const init = () => {
      if (!checkRecentLogin()) {
        showSignup();
      }
      addEventListeners();
      if (state.currentUser) {
        if (state.chats.length > 0) {
          state.selectedChat = state.chats[0];
          syncModelSelector();
          syncModeSelector();
        } else {
          addNewChat();
        }
        updateUI();
      }
    };

    init();
  </script>
</body>
</html>